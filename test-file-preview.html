<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶é¢„è§ˆæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .file-item {
            display: inline-block;
            margin: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            text-align: center;
        }
        .file-item img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
        }
        .file-item video {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
        }
        .download-btn {
            margin-top: 5px;
            padding: 4px 8px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .error {
            color: red;
            background: #ffe6e6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: green;
            background: #e6ffe6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>æ–‡ä»¶é¢„è§ˆå’Œä¸‹è½½åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>æµ‹è¯•è¯´æ˜</h2>
        <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•æ–‡ä»¶é¢„è§ˆå’Œä¸‹è½½åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>
        <p>è¯·å…ˆä¸Šä¼ ä¸€äº›æ–‡ä»¶ï¼Œç„¶åæ£€æŸ¥é¢„è§ˆå’Œä¸‹è½½åŠŸèƒ½ã€‚</p>
    </div>

    <div class="test-section">
        <h2>æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h2>
        <input type="file" id="fileInput" multiple accept="image/*,video/*,.pdf,.doc,.docx,.txt">
        <button onclick="uploadFiles()">ä¸Šä¼ æ–‡ä»¶</button>
        <div id="uploadStatus"></div>
    </div>

    <div class="test-section">
        <h2>æ–‡ä»¶é¢„è§ˆæµ‹è¯•</h2>
        <div id="fileList"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000';
        let uploadedFiles = [];

        function getFileType(url) {
            const extension = url.split('.').pop().toLowerCase();
            if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(extension)) {
                return 'image';
            } else if (['mp4', 'avi', 'mov', 'wmv', 'flv', 'webm'].includes(extension)) {
                return 'video';
            } else if (['pdf'].includes(extension)) {
                return 'pdf';
            } else if (['doc', 'docx'].includes(extension)) {
                return 'word';
            } else if (['xls', 'xlsx'].includes(extension)) {
                return 'excel';
            } else if (['ppt', 'pptx'].includes(extension)) {
                return 'powerpoint';
            } else {
                return 'file';
            }
        }

        function getFileIcon(fileType) {
            switch (fileType) {
                case 'image': return 'ğŸ–¼ï¸';
                case 'video': return 'ğŸ¥';
                case 'pdf': return 'ğŸ“„';
                case 'word': return 'ğŸ“';
                case 'excel': return 'ğŸ“Š';
                case 'powerpoint': return 'ğŸ“Š';
                default: return 'ğŸ“';
            }
        }

        function handleDownload(url) {
            console.log('ä¸‹è½½æ–‡ä»¶:', url);
            const link = document.createElement('a');
            const cleanUrl = url.startsWith('/') ? url : `/${url}`;
            const fullUrl = `${API_BASE_URL}/uploads${cleanUrl}`;
            console.log('ä¸‹è½½URL:', fullUrl);
            
            link.href = fullUrl;
            link.download = url.split('/').pop();
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showImageModal(url) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.9);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            modal.innerHTML = `
                <img src="${url}" style="max-width: 90%; max-height: 90%; object-fit: contain;" onclick="this.parentElement.remove()">
            `;
            document.body.appendChild(modal);
        }

        async function uploadFiles() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            
            if (files.length === 0) {
                document.getElementById('uploadStatus').innerHTML = '<div class="error">è¯·é€‰æ‹©æ–‡ä»¶</div>';
                return;
            }

            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }

            try {
                document.getElementById('uploadStatus').innerHTML = '<div>ä¸Šä¼ ä¸­...</div>';
                
                const response = await fetch(`${API_BASE_URL}/api/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('ä¸Šä¼ å¤±è´¥: ' + response.status);
                }

                const result = await response.json();
                console.log('ä¸Šä¼ ç»“æœ:', result);
                
                uploadedFiles = result.urls;
                document.getElementById('uploadStatus').innerHTML = '<div class="success">ä¸Šä¼ æˆåŠŸï¼</div>';
                renderFilePreview();
                
            } catch (error) {
                console.error('ä¸Šä¼ é”™è¯¯:', error);
                document.getElementById('uploadStatus').innerHTML = `<div class="error">ä¸Šä¼ å¤±è´¥: ${error.message}</div>`;
            }
        }

        function renderFilePreview() {
            const fileListDiv = document.getElementById('fileList');
            fileListDiv.innerHTML = '';

            if (uploadedFiles.length === 0) {
                fileListDiv.innerHTML = '<p>æ²¡æœ‰æ–‡ä»¶</p>';
                return;
            }

            uploadedFiles.forEach((url, index) => {
                const fileType = getFileType(url);
                const cleanUrl = url.startsWith('/') ? url : `/${url}`;
                const fullUrl = `${API_BASE_URL}/uploads${cleanUrl}`;
                const fileName = url.split('/').pop();

                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';

                if (fileType === 'image') {
                    fileItem.innerHTML = `
                        <img src="${fullUrl}" alt="${fileName}" onclick="showImageModal('${fullUrl}')" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div style="display: none; font-size: 48px; margin: 20px 0;">${getFileIcon(fileType)}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px; word-break: break-all;">${fileName}</div>
                        <button class="download-btn" onclick="handleDownload('${url}')">ä¸‹è½½</button>
                    `;
                } else if (fileType === 'video') {
                    fileItem.innerHTML = `
                        <video src="${fullUrl}" controls 
                               onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"></video>
                        <div style="display: none; font-size: 48px; margin: 20px 0;">${getFileIcon(fileType)}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px; word-break: break-all;">${fileName}</div>
                        <button class="download-btn" onclick="handleDownload('${url}')">ä¸‹è½½</button>
                    `;
                } else {
                    fileItem.innerHTML = `
                        <div style="font-size: 48px; margin: 20px 0;">${getFileIcon(fileType)}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px; word-break: break-all;">${fileName}</div>
                        <button class="download-btn" onclick="handleDownload('${url}')">ä¸‹è½½</button>
                    `;
                }

                fileListDiv.appendChild(fileItem);
            });
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        window.addEventListener('load', async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (response.ok) {
                    console.log('âœ… æœåŠ¡å™¨è¿æ¥æ­£å¸¸');
                } else {
                    console.log('âŒ æœåŠ¡å™¨å“åº”å¼‚å¸¸');
                }
            } catch (error) {
                console.log('âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨:', error.message);
                document.getElementById('uploadStatus').innerHTML = '<div class="error">æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ</div>';
            }
        });
    </script>
</body>
</html>
