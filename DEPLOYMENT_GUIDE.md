# 部署指南 - 解决文件丢失问题

## 问题描述
每次重新部署时，服务器会重新启动，本地的`uploads`文件夹会被清空，导致之前上传的文件丢失。

## 解决方案

### 方案1：使用Render持久化存储（推荐）

1. **在Render控制台中启用持久化存储**：
   - 进入您的Render服务设置
   - 找到"Disk"部分
   - 添加一个新的磁盘：
     - 名称：`platform-program-disk`
     - 挂载路径：`/opt/render/project/src/uploads`
     - 大小：1GB（可根据需要调整）

2. **使用render.yaml配置**：
   - 项目根目录已包含`render.yaml`配置文件
   - 在Render中导入此配置即可自动设置持久化存储

### 方案2：使用云存储服务

1. **配置AWS S3**（需要AWS账户）：
   ```bash
   # 设置环境变量
   AWS_ACCESS_KEY_ID=your_access_key
   AWS_SECRET_ACCESS_KEY=your_secret_key
   AWS_REGION=us-east-1
   AWS_S3_BUCKET=your-bucket-name
   ```

2. **安装依赖**：
   ```bash
   npm install aws-sdk multer-s3
   ```

3. **使用云存储**：
   - 修改`server/index.js`中的文件上传配置
   - 使用`cloudStorage.js`中的配置

### 方案3：自动备份系统（已实现）

项目已包含自动备份系统：

1. **自动备份**：
   - 服务器启动时自动创建文件备份
   - 每次启动时尝试恢复最新备份
   - 自动清理旧备份（保留最近5个）

2. **手动备份管理**：
   - `GET /api/admin/backups` - 获取备份列表
   - `POST /api/admin/backup/create` - 创建备份
   - `POST /api/admin/backup/restore` - 恢复备份

## 推荐部署步骤

### 使用Render持久化存储：

1. **在Render控制台中**：
   - 进入服务设置
   - 添加持久化磁盘
   - 挂载到`/opt/render/project/src/uploads`

2. **重新部署**：
   - 推送代码到GitHub
   - Render会自动重新部署
   - 文件将保存在持久化存储中

### 验证部署：

1. **检查文件上传**：
   - 上传一些测试文件
   - 确认文件可以正常预览和下载

2. **测试重新部署**：
   - 进行代码更新并重新部署
   - 确认之前的文件仍然可以访问

## 注意事项

1. **持久化存储成本**：
   - Render的持久化存储会产生额外费用
   - 建议根据实际使用情况选择合适的大小

2. **备份策略**：
   - 定期检查备份是否正常创建
   - 重要文件建议额外备份到其他位置

3. **监控存储使用**：
   - 定期清理不需要的文件
   - 监控存储空间使用情况

## 故障排除

如果文件仍然丢失：

1. **检查挂载路径**：
   - 确认Render磁盘正确挂载到指定路径
   - 检查服务器日志中的路径信息

2. **检查权限**：
   - 确认应用有权限写入挂载目录
   - 检查文件权限设置

3. **查看日志**：
   - 检查服务器启动日志
   - 查看备份恢复是否成功

## 联系支持

如果遇到问题，请：
1. 检查服务器日志
2. 确认Render配置正确
3. 联系技术支持