<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="x5-orientation" content="portrait">
    <meta name="x5-fullscreen" content="true">
    <meta name="x5-page-mode" content="app">
    <meta name="browsermode" content="application">
    <meta name="x5-cache" content="false">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>艺术平台 - 微信版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            background: #667eea;
            background: -webkit-linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            line-height: 1.6;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .status {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .status.loading {
            background: rgba(52, 152, 219, 0.3);
        }
        
        .status.error {
            background: rgba(231, 76, 60, 0.3);
        }
        
        .status.success {
            background: rgba(39, 174, 96, 0.3);
        }
        
        .button {
            display: inline-block;
            padding: 12px 24px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            margin: 5px;
            font-size: 16px;
            border: none;
            cursor: pointer;
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .button:hover {
            background: #2980b9;
        }
        
        .button:active {
            background: #21618c;
        }
        
        .button.success {
            background: #27ae60;
        }
        
        .button.error {
            background: #e74c3c;
        }
        
        .info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .info strong {
            display: block;
            margin-bottom: 5px;
        }
        
        .hidden {
            display: none;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .debug {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎨 海淀外国语国际部艺术平台</h1>
            <p>HFLS International Art Platform</p>
        </div>
        
        <div id="status" class="status loading">
            <div class="loading-spinner"></div>
            <div>正在检测微信浏览器兼容性...</div>
        </div>
        
        <div id="browser-info" class="info hidden">
            <strong>浏览器信息：</strong>
            <div id="browser-details"></div>
        </div>
        
        <div id="test-results" class="info hidden">
            <strong>兼容性测试：</strong>
            <div id="test-details"></div>
        </div>
        
        <div id="actions" class="hidden">
            <button class="button" onclick="loadMainApp()">🏠 进入主应用</button>
            <button class="button" onclick="refreshPage()">🔄 刷新页面</button>
            <button class="button" onclick="showDebug()">🔍 显示调试信息</button>
        </div>
        
        <div id="debug-info" class="debug hidden"></div>
    </div>

    <script>
        // 微信浏览器检测和兼容性修复
        (function() {
            var status = document.getElementById('status');
            var browserInfo = document.getElementById('browser-info');
            var testResults = document.getElementById('test-results');
            var actions = document.getElementById('actions');
            var debugInfo = document.getElementById('debug-info');
            
            var userAgent = navigator.userAgent;
            var isWeChat = /micromessenger/i.test(userAgent);
            var isMobile = /mobile|android|iphone|ipad|phone/i.test(userAgent);
            var isIOS = /iphone|ipad|ipod/i.test(userAgent);
            var isAndroid = /android/i.test(userAgent);
            
            var debugData = {
                userAgent: userAgent,
                isWeChat: isWeChat,
                isMobile: isMobile,
                isIOS: isIOS,
                isAndroid: isAndroid,
                screenWidth: window.innerWidth,
                screenHeight: window.innerHeight,
                devicePixelRatio: window.devicePixelRatio || 1,
                timestamp: new Date().toISOString()
            };
            
            function updateStatus(message, type) {
                status.className = 'status ' + type;
                status.innerHTML = '<div>' + message + '</div>';
            }
            
            function showBrowserInfo() {
                browserInfo.className = 'info';
                document.getElementById('browser-details').innerHTML = 
                    '微信浏览器: ' + (isWeChat ? '是' : '否') + '<br>' +
                    '移动设备: ' + (isMobile ? '是' : '否') + '<br>' +
                    '操作系统: ' + (isIOS ? 'iOS' : isAndroid ? 'Android' : '其他') + '<br>' +
                    '屏幕尺寸: ' + window.innerWidth + 'x' + window.innerHeight + '<br>' +
                    '设备像素比: ' + (window.devicePixelRatio || 1);
            }
            
            function runCompatibilityTests() {
                var tests = [];
                
                // 测试1: JavaScript基本功能
                try {
                    var testObj = { test: 'value' };
                    var testArray = [1, 2, 3];
                    if (testObj.test === 'value' && testArray.length === 3) {
                        tests.push('✓ JavaScript基本功能正常');
                    } else {
                        tests.push('✗ JavaScript基本功能异常');
                    }
                } catch (e) {
                    tests.push('✗ JavaScript错误: ' + e.message);
                }
                
                // 测试2: DOM操作
                try {
                    var testDiv = document.createElement('div');
                    testDiv.id = 'test-dom';
                    document.body.appendChild(testDiv);
                    var foundDiv = document.getElementById('test-dom');
                    if (foundDiv) {
                        tests.push('✓ DOM操作正常');
                        document.body.removeChild(foundDiv);
                    } else {
                        tests.push('✗ DOM操作异常');
                    }
                } catch (e) {
                    tests.push('✗ DOM操作错误: ' + e.message);
                }
                
                // 测试3: CSS渐变支持
                try {
                    var testDiv = document.createElement('div');
                    testDiv.style.background = 'linear-gradient(45deg, #ff0000, #0000ff)';
                    testDiv.style.position = 'absolute';
                    testDiv.style.left = '-100px';
                    testDiv.style.top = '-100px';
                    testDiv.style.width = '50px';
                    testDiv.style.height = '50px';
                    document.body.appendChild(testDiv);
                    
                    var computedStyle = window.getComputedStyle(testDiv);
                    var background = computedStyle.background || computedStyle.backgroundImage;
                    
                    if (background && background.indexOf('gradient') !== -1) {
                        tests.push('✓ CSS渐变支持正常');
                    } else {
                        tests.push('⚠ CSS渐变支持有限');
                    }
                    
                    document.body.removeChild(testDiv);
                } catch (e) {
                    tests.push('✗ CSS渐变测试错误: ' + e.message);
                }
                
                // 测试4: 触摸支持
                if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
                    tests.push('✓ 触摸事件支持');
                } else {
                    tests.push('⚠ 触摸事件不支持');
                }
                
                // 测试5: 视口支持
                if (window.innerWidth > 0 && window.innerHeight > 0) {
                    tests.push('✓ 视口尺寸正常');
                } else {
                    tests.push('✗ 视口尺寸异常');
                }
                
                return tests;
            }
            
            function showTestResults() {
                var tests = runCompatibilityTests();
                testResults.className = 'info';
                document.getElementById('test-details').innerHTML = tests.join('<br>');
                
                // 计算通过率
                var passedTests = tests.filter(function(test) {
                    return test.indexOf('✓') === 0;
                }).length;
                var totalTests = tests.length;
                var passRate = Math.round((passedTests / totalTests) * 100);
                
                debugData.testResults = tests;
                debugData.passRate = passRate;
                
                return passRate;
            }
            
            function showActions() {
                actions.className = '';
            }
            
            function showDebug() {
                debugInfo.className = 'debug';
                debugInfo.textContent = JSON.stringify(debugData, null, 2);
            }
            
            function loadMainApp() {
                updateStatus('正在加载主应用...', 'loading');
                
                // 尝试加载主应用
                var iframe = document.createElement('iframe');
                iframe.src = '/';
                iframe.style.width = '100%';
                iframe.style.height = '600px';
                iframe.style.border = 'none';
                iframe.style.borderRadius = '10px';
                
                iframe.onload = function() {
                    updateStatus('主应用加载成功！', 'success');
                    showActions();
                };
                
                iframe.onerror = function() {
                    updateStatus('主应用加载失败，请检查网络连接', 'error');
                    showActions();
                };
                
                // 替换当前内容
                document.body.innerHTML = '';
                document.body.appendChild(iframe);
            }
            
            function refreshPage() {
                window.location.reload();
            }
            
            // 主执行流程
            function init() {
                console.log('微信浏览器兼容性检测开始...');
                
                // 显示浏览器信息
                showBrowserInfo();
                
                // 运行兼容性测试
                var passRate = showTestResults();
                
                // 根据测试结果决定下一步
                if (passRate >= 80) {
                    updateStatus('兼容性检测通过！可以正常使用', 'success');
                    showActions();
                } else if (passRate >= 60) {
                    updateStatus('兼容性一般，建议刷新后重试', 'error');
                    showActions();
                } else {
                    updateStatus('兼容性较差，可能需要更新微信版本', 'error');
                    showActions();
                }
                
                // 微信浏览器特殊处理
                if (isWeChat) {
                    console.log('检测到微信浏览器，应用特殊修复...');
                    
                    // 强制重绘
                    document.body.style.webkitTransform = 'translateZ(0)';
                    document.body.style.transform = 'translateZ(0)';
                    document.body.style.webkitBackfaceVisibility = 'hidden';
                    document.body.style.backfaceVisibility = 'hidden';
                    
                    // 防止微信浏览器缓存问题
                    if (window.location.search.indexOf('t=') === -1) {
                        var newUrl = window.location.href + (window.location.search ? '&' : '?') + 't=' + Date.now();
                        window.history.replaceState({}, '', newUrl);
                    }
                }
            }
            
            // 错误处理
            window.addEventListener('error', function(e) {
                console.error('页面错误:', e);
                updateStatus('页面发生错误: ' + e.message, 'error');
                showActions();
            });
            
            // 页面加载完成后执行
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
            
            // 暴露全局函数
            window.loadMainApp = loadMainApp;
            window.refreshPage = refreshPage;
            window.showDebug = showDebug;
            
        })();
    </script>
</body>
</html>
