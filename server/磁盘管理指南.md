# 磁盘管理指南

## 📊 **当前删除功能状态**

### ✅ **会自动删除磁盘文件的功能**

| 功能 | API | 删除内容 | 状态 |
|------|-----|---------|------|
| 删除艺术作品 | `DELETE /api/art/:id` | ✅ 所有media文件 | 正常 |
| 删除活动 | `DELETE /api/activities/:id` | ✅ image + media文件 | 正常 |
| 删除资料库 | `DELETE /api/resources/:id` | ✅ 所有files | 正常 |
| 删除作品集 | `DELETE /api/portfolio/:id` | ✅ coverImage | 正常 |
| **删除作品集内容** | `DELETE /api/portfolio/:id/contents/:contentId` | ✅ 所有media文件 | **新增** |
| **删除反馈** | `DELETE /api/feedback/:id` | ✅ 所有media文件 | **新增** |

---

## 🧹 **如何清理孤立文件**

### **方法1：自动检测和清理（推荐）**

#### **步骤1：检查孤立文件**
```bash
cd server
node cleanup-orphaned-files.js
```

**输出示例：**
```
========================================
开始清理孤立文件...
上传目录: /path/to/uploads
========================================

磁盘文件总数: 150

检查艺术作品中的文件引用...
  艺术作品引用文件: 45 个
检查活动中的文件引用...
  活动引用文件: 58 个（累计）
检查反馈中的文件引用...
  反馈引用文件: 62 个（累计）
检查作品集中的文件引用...
  作品集引用文件: 75 个（累计）
检查资料库中的文件引用...
  资料库引用文件: 120 个（累计）

数据库中引用的文件总数: 120

发现 30 个孤立文件

孤立文件列表:
  1. 1696123456789-123456789.png (2.45 MB)
  2. 1696234567890-987654321.mp4 (15.32 MB)
  ...

孤立文件总大小: 125.67 MB

========================================
是否删除这些孤立文件？
运行命令: node cleanup-orphaned-files.js --delete
========================================
```

#### **步骤2：删除孤立文件**
```bash
node cleanup-orphaned-files.js --delete
```

**输出示例：**
```
开始删除孤立文件...

✅ 已删除: 1696123456789-123456789.png
✅ 已删除: 1696234567890-987654321.mp4
...

删除完成！成功删除 30/30 个文件
释放空间: 125.67 MB
```

---

### **方法2：手动清理**

#### **查看uploads目录**
```bash
cd server/uploads
ls -lh
```

#### **查看文件大小**
```bash
du -sh *
```

#### **手动删除特定文件**
```bash
rm 1696123456789-123456789.png
```

---

## 💾 **如何备份磁盘数据**

### **方法1：使用备份脚本（推荐）**

```bash
cd server
./backup-uploads.sh
```

**输出示例：**
```
========================================
开始备份上传文件...
========================================

上传目录: ./uploads
备份目录: ./backups/uploads/backup_20251012_143025

文件数量: 120
总大小: 2.3G

开始复制文件...
✅ 备份成功！

备份位置: ./backups/uploads/backup_20251012_143025
备份信息已保存到: ./backups/uploads/backup_20251012_143025/backup_info.txt

最近的备份列表:
drwxr-xr-x backup_20251012_143025
drwxr-xr-x backup_20251011_120000
drwxr-xr-x backup_20251010_093015

========================================
备份完成！
========================================
```

**备份存储位置：**
```
server/backups/uploads/
├── backup_20251012_143025/
│   ├── backup_info.txt
│   ├── 1696123456789-123456789.png
│   ├── 1696234567890-987654321.mp4
│   └── ...
├── backup_20251011_120000/
└── backup_20251010_093015/
```

---

### **方法2：手动备份**

#### **完整备份**
```bash
cd server
cp -R uploads backups/uploads_$(date +%Y%m%d_%H%M%S)
```

#### **压缩备份（节省空间）**
```bash
cd server
tar -czf backups/uploads_$(date +%Y%m%d_%H%M%S).tar.gz uploads/
```

#### **查看备份**
```bash
ls -lh backups/
```

---

### **方法3：定期自动备份**

#### **创建cron任务（每天凌晨3点备份）**
```bash
crontab -e
```

添加以下行：
```
0 3 * * * cd /path/to/server && ./backup-uploads.sh
```

---

## 🔄 **恢复备份**

### **从备份恢复**
```bash
cd server
cp -R backups/uploads/backup_20251012_143025/* uploads/
```

### **从压缩包恢复**
```bash
cd server
tar -xzf backups/uploads_20251012_143025.tar.gz
```

---

## 📈 **磁盘使用监控**

### **查看uploads目录大小**
```bash
cd server
du -sh uploads/
```

### **查看单个文件大小**
```bash
cd server/uploads
ls -lh | sort -k5 -hr | head -20
```

### **统计文件类型**
```bash
cd server/uploads
find . -type f | sed 's/.*\.//' | sort | uniq -c | sort -nr
```

**输出示例：**
```
  45 png
  32 jpg
  15 mp4
  12 pdf
  10 docx
   6 xlsx
```

---

## ⚠️ **注意事项**

### **清理孤立文件前：**
1. ✅ 先运行检查命令（不加--delete参数）
2. ✅ 确认列出的文件确实是孤立的
3. ✅ 考虑先备份（以防误删）
4. ✅ 再运行删除命令（加--delete参数）

### **备份建议：**
1. ✅ 定期备份（建议每周一次）
2. ✅ 保留至少3个备份
3. ✅ 压缩备份以节省空间
4. ✅ 重要数据异地备份

### **Render部署特别注意：**
⚠️ Render免费版会定期重置磁盘，所以：
- uploads目录会丢失
- 建议使用云存储（如Cloudinary、AWS S3）
- 或升级到付费版获得持久化存储

---

## 🚀 **快速命令参考**

```bash
# 检查孤立文件
node cleanup-orphaned-files.js

# 删除孤立文件
node cleanup-orphaned-files.js --delete

# 备份上传文件
./backup-uploads.sh

# 查看磁盘使用
du -sh uploads/

# 查看备份列表
ls -lh backups/uploads/
```

---

## 💡 **最佳实践**

1. **定期检查（每月）**
   ```bash
   node cleanup-orphaned-files.js
   ```

2. **定期备份（每周）**
   ```bash
   ./backup-uploads.sh
   ```

3. **删除前备份**
   ```bash
   ./backup-uploads.sh
   node cleanup-orphaned-files.js --delete
   ```

4. **监控磁盘使用**
   ```bash
   du -sh uploads/
   ```

